# Taskinfa-Kanban Multi-Project Workers
# Docker Compose configuration for running multiple isolated workers
#
# NEW MODEL: Workers are like "dev employees" with names (e.g., "John", "Sarah")
# A single worker can work on multiple projects - they fetch the highest
# priority task across ALL projects and clone repos as needed.
#
# Usage:
#   Single worker:    docker-compose -f docker-compose.workers.yml up worker-john
#   Multiple workers: docker-compose -f docker-compose.workers.yml --profile multi-worker up
#   All workers:      docker-compose -f docker-compose.workers.yml --profile multi-worker up -d
#
# Required environment variables (set in .env or export):
#   - TASKINFA_API_KEY: API key for authentication with Taskinfa dashboard
#   - ANTHROPIC_API_KEY: Claude API key for Claude Code CLI
#   - GITHUB_TOKEN: (Optional) For cloning private repositories

version: '3.8'

services:
  # Worker: John
  # Primary worker for general tasks
  worker-john:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: taskinfa-worker-john
    hostname: worker-john
    environment:
      - WORKER_NAME=John
      - TASKINFA_API_KEY=${TASKINFA_API_KEY}
      - TASKINFA_API_URL=${TASKINFA_API_URL:-https://taskinfa-kanban.secan-ltd.workers.dev/api}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - POLL_INTERVAL=${POLL_INTERVAL:-30}
    volumes:
      # Shared workspace for all projects (persisted between container restarts)
      - worker-john-workspace:/workspace
      # Log files (accessible from host)
      - ./logs/john:/app/logs
    restart: unless-stopped
    networks:
      - taskinfa-workers

  # Worker: Sarah
  # Secondary worker for parallel task processing
  worker-sarah:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: taskinfa-worker-sarah
    hostname: worker-sarah
    environment:
      - WORKER_NAME=Sarah
      - TASKINFA_API_KEY=${TASKINFA_API_KEY}
      - TASKINFA_API_URL=${TASKINFA_API_URL:-https://taskinfa-kanban.secan-ltd.workers.dev/api}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - POLL_INTERVAL=${POLL_INTERVAL:-30}
    volumes:
      - worker-sarah-workspace:/workspace
      - ./logs/sarah:/app/logs
    restart: unless-stopped
    networks:
      - taskinfa-workers
    profiles:
      - multi-worker

  # Worker: Mike
  # Additional worker for high-volume processing
  worker-mike:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: taskinfa-worker-mike
    hostname: worker-mike
    environment:
      - WORKER_NAME=Mike
      - TASKINFA_API_KEY=${TASKINFA_API_KEY}
      - TASKINFA_API_URL=${TASKINFA_API_URL:-https://taskinfa-kanban.secan-ltd.workers.dev/api}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - POLL_INTERVAL=${POLL_INTERVAL:-30}
    volumes:
      - worker-mike-workspace:/workspace
      - ./logs/mike:/app/logs
    restart: unless-stopped
    networks:
      - taskinfa-workers
    profiles:
      - multi-worker

# Named volumes for persistent workspaces
# Each worker has its own isolated workspace to avoid conflicts
# Projects are cloned into /workspace/{project_id}/ inside each volume
volumes:
  worker-john-workspace:
    driver: local
  worker-sarah-workspace:
    driver: local
  worker-mike-workspace:
    driver: local

# Network for worker communication
networks:
  taskinfa-workers:
    driver: bridge
