# Orchestrator

`scripts/orchestrator.ts` — Node.js daemon, polls `/api/tasks`, spawns Claude sessions.

## Task Status Flow

```
backlog → todo → in_progress → ai_review → review → done
                             ↘ review_rejected (fix loop)
         ↗ refinement (optional task description improvement)
```

- Orchestrator picks up `todo` tasks, claims them (`in_progress`), spawns a Claude session
- Session exit code 0 → orchestrator advances to `ai_review`
- Session exit code non-0 → retry or `blocked`
- **Never mark a task `done` from inside a session** — orchestrator handles transitions

## Poll Cycle Priority Order

1. Initialize uninitialized projects (clone repos)
2. Time-out stuck sessions
3. Handle completed/failed sessions (advance/retry tasks)
4. Launch new sessions for todo tasks (up to MAX_CONCURRENT)

## Session Types

- **Standard task session**: works on a single `todo` task, creates PR, exits 0
- **Refinement session**: improves task description, exits 0, task returns to `todo`

## Env Vars

| Variable | Local | Production |
|---|---|---|
| `KANBAN_API_URL` | `http://localhost:3000` | prod workers URL |
| `KANBAN_API_KEY` | generated by dev.sh | set via wrangler secret |
| `POLL_INTERVAL` | `10000` (10s) | `900000` (15min) |
| `PROJECTS_DIR` | `~/workspace/taskinfa-dev-projects` | `/workspace/projects` |
| `GH_TOKEN` | from `gh auth token` | set via wrangler secret |
| `MAX_CONCURRENT` | `3` | `3` |
| `MAX_RETRIES` | `3` | `3` |
| `SESSION_TIMEOUT_MS` | — | `2700000` (45min) |
