# Taskinfa Kanban — Claude Code Rules

Repository: https://github.com/secanltd/taskinfa-kanban
> For history and past decisions: `git log --oneline`

---

## Local Development

One command boots the full stack:
```bash
git pull origin main && ./dev.sh
```

What `dev.sh` does automatically on every fresh start:
1. Resets and re-migrates the local D1 database
2. Creates `packages/dashboard/.dev.vars` and `.env.local` with a fresh `JWT_SECRET`
3. Creates `~/workspace/taskinfa-dev-projects/` (the local projects directory)
4. Starts Next.js dashboard on port 3000
5. Seeds dev user + API key via the live API
6. Seeds test projects (alpha + beta repos) as task_lists in the kanban board
7. Writes root `.env` for the orchestrator (API key, PROJECTS_DIR, GH_TOKEN, poll interval)
8. Starts the orchestrator — it polls every 10s and clones the test repos on first cycle

Dev user credentials (seeded fresh each run):
- Email: `dev@taskinfa.local`
- Password: `DevPass123!`

Skip the orchestrator when only working on the UI:
```bash
./dev.sh --no-orchestrator
```

### dev-sh-config.json

All non-secret local dev settings live in `dev-sh-config.json` (committed to repo):
- `port` — dashboard port (default 3000)
- `devUser` — seeded user credentials
- `orchestrator.pollInterval` — ms between polls (10000 locally)
- `orchestrator.projectsDir` — where repos are cloned (`~/workspace/taskinfa-dev-projects`)
- `testProjects` — list of repos seeded into the kanban board on each `dev.sh` run

To add a new test project, add an entry to `testProjects` in `dev-sh-config.json` and commit it.

### Auto-generated files (gitignored — do not commit)
- `packages/dashboard/.dev.vars` — Cloudflare bindings for local dev
- `packages/dashboard/.env.local` — Next.js process.env secrets
- `.env` — orchestrator config (API key, PROJECTS_DIR, GH_TOKEN)
- `.dev-dashboard.log` / `.dev-orchestrator.log` — runtime logs

---

## Architecture

```
packages/dashboard      Next.js app → Cloudflare Workers (@opennextjs/cloudflare)
packages/telegram       Cloudflare Worker, Telegram bot, shares D1 database
scripts/orchestrator.ts Node.js daemon — polls /api/tasks, spawns Claude sessions
.claude/settings.json   Claude hooks — POSTs events to /api/events
```

### Task lifecycle (status flow)
```
backlog → todo → in_progress → ai_review → review → done
                             ↘ review_rejected (fix loop)
         ↗ refinement (optional task description improvement)
```
The orchestrator picks up `todo` tasks, claims them (`in_progress`), and spawns a Claude session in the project's working directory.

### Project (task_list) lifecycle
1. Project created in kanban with a `repository_url`
2. Orchestrator detects `is_initialized = false` → clones repo to `$PROJECTS_DIR/<project-id>/`
3. Orchestrator PATCHes task_list with `working_directory` and `is_initialized = true`
4. All subsequent Claude sessions for that project run with cwd = `working_directory`
5. Sessions read `CLAUDE.md` and `.memory/context.md` from the project root

### Key API routes
- `GET/POST /api/tasks` — task CRUD; orchestrator polls this
- `GET/POST /api/task-lists` — project CRUD
- `GET/POST /api/sessions` — Claude session tracking
- `POST /api/events` — receives Claude hook events, triggers Telegram notifications
- `GET/POST /api/keys` — API key management
- `GET /overview` — global project status

### Orchestrator env vars (written by `dev.sh`; set manually for prod)
| Variable | Local | Production |
|---|---|---|
| `KANBAN_API_URL` | `http://localhost:3000` | prod workers URL |
| `KANBAN_API_KEY` | generated by dev.sh | set via wrangler secret |
| `POLL_INTERVAL` | `10000` (10s) | `900000` (15min) |
| `PROJECTS_DIR` | `~/workspace/taskinfa-dev-projects` | `/workspace/projects` |
| `GH_TOKEN` | from `gh auth token` | set via wrangler secret |
| `MAX_CONCURRENT` | `3` | `3` |

---

## For Claude Sessions Spawned by the Orchestrator

When the orchestrator starts a Claude session, it runs inside a **project repo** (e.g. `test-project-alpha`), NOT inside this kanban dashboard repo. The following rules apply to those sessions.

### ✅ DO
- Work only on the assigned task — read the task description carefully
- Create a feature branch, commit changes, push, and open a PR
- Update `.memory/context.md` in the project root with a summary of what you did
- Use `KANBAN_API_URL` + `KANBAN_API_KEY` env vars (already set by orchestrator) for any API calls back to the kanban board
- Follow the project's own `CLAUDE.md` if one exists in the project root
- Keep commits small and focused; use Conventional Commits format

### ❌ DON'T
- Never push directly to `main` in any repo
- Never modify this kanban dashboard codebase from inside a project session
- Never install packages without a clear reason tied to the task
- Never create files outside the project working directory
- Never skip tests if the project has a test suite
- Never commit `.env`, secrets, or credentials
- Never mark a task as `done` yourself — the orchestrator handles status transitions based on exit code

---

## Git Rules (this repo)

**NEVER push directly to `main` — it is protected.**

When asked to commit:
1. Create a branch: `feat/short-name` or `fix/short-name`
2. Commit on that branch
3. Push with `-u`
4. Output the PR URL: `https://github.com/secanltd/taskinfa-kanban/compare/<branch>?expand=1`

**NEVER add Co-Authored-By lines to commits.**

Commit format — Conventional Commits:
```
feat: add priority filter to task list

- filter applied in GET /api/tasks
- UI dropdown in kanban header
```
Prefixes: `feat` `fix` `docs` `refactor` `test` `chore`

Branch naming: `feat/` `fix/` `docs/` `refactor/`

---

## Database Migrations

Always use `migrations apply` — never `execute --file` (bypasses tracking).

```bash
# Create
cd packages/dashboard && npm run db:migrations:create -- describe_change

# Test locally (dev.sh already does this on startup)
npm run db:migrate

# Deploy to test/prod via CI — push a tag:
git tag migratedb/test/vX.Y.Z && git push origin migratedb/test/vX.Y.Z
git tag migratedb/prod/vX.Y.Z && git push origin migratedb/prod/vX.Y.Z
```

Never delete migration files. One change per migration. Document with SQL comments.

---

## Deployment

We use `@opennextjs/cloudflare` — **not** the deprecated `@cloudflare/next-on-pages`.

Deploy via CI by pushing a tag (never deploy manually unless emergency):
```bash
git tag deploy/test/X.Y.Z && git push origin deploy/test/X.Y.Z
git tag deploy/prod/X.Y.Z && git push origin deploy/prod/X.Y.Z
```

URLs:
- Test: https://taskinfa-kanban-test.secan-ltd.workers.dev
- Prod: https://taskinfa-kanban-prod.secan-ltd.workers.dev

Critical rules for route files — **do not add** `export const runtime = 'edge'`. The Workers adapter uses Node.js runtime automatically. Build output goes to `.open-next/`, not `.vercel/`.

Required Worker secrets (set via `wrangler secret put <KEY> --env <test|production>`):
- `JWT_SECRET`

---

## Code Style

- TypeScript: explicit types, no `any`, `async/await`, `try/catch`
- React: functional components, hooks, small focused components, interfaces for props
- Types shared via `packages/shared` — export from there, not inline
- Never commit secrets, credentials, or `.env` files
- SQL: always use parameterized queries
