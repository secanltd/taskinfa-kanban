var O={},X=(G,z,L)=>(O.__chunk_3136=(U,Y,a)=>{"use strict";a.d(Y,{$G:()=>j,C0:()=>v,jw:()=>t,mj:()=>H,zP:()=>f});var g=a(7481),E=a(8275);let I=process.env.SESSION_SECRET||process.env.JWT_SECRET||"dev-secret-change-in-production",x=new TextEncoder().encode(I),J="session_token",W=parseInt(process.env.SESSION_MAX_AGE||"604800",10);async function t(d,l){return await new g.P({userId:d,workspaceId:l,type:"user"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(`${W}s`).sign(x)}async function f(d){try{let{payload:l}=await(0,E.V)(d,x);return typeof l.userId!="string"||typeof l.workspaceId!="string"||l.type!=="user"?null:l}catch(l){return console.error("Session verification failed:",l),null}}function j(d,l){return d.cookies.set({name:J,value:l,httpOnly:!0,secure:!0,sameSite:"lax",maxAge:W,path:"/"}),d}function v(d){return d.cookies.delete(J),d}function H(d){return d.get(J)?.value||null}},O.__chunk_8275=(U,Y,a)=>{a.d(Y,{V:()=>M});var g=a(469),E=a(7507),I=a(2926),x=a(7564),J=a(4246);let W=async(e,i,u,s)=>{let c=await(0,J.A)(e,i,"verify");(0,x.A)(e,c);let n=(0,E.A)(e,c.algorithm);try{return await I.A.subtle.verify(n,c,u,s)}catch{return!1}};var t=a(1636),f=a(848),j=a(4439),v=a(5552),H=a(2861),d=a(6105),l=a(1847),N=a(1053);async function q(e,i){if(!(0,v.A)(e))throw TypeError("JWK must be an object");switch(i||(i=e.alg),e.kty){case"oct":if(typeof e.k!="string"||!e.k)throw TypeError('missing "k" (Key Value) Parameter value');return(0,g.D4)(e.k);case"RSA":if("oth"in e&&e.oth!==void 0)throw new t.T0('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return(0,N.A)({...e,alg:i});default:throw new t.T0('Unsupported "kty" (Key Type) Parameter value')}}async function K(e,i,u){let s,c;if(!(0,v.A)(e))throw new t.Ye("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new t.Ye('Flattened JWS must have either of the "protected" or "header" members');if(e.protected!==void 0&&typeof e.protected!="string")throw new t.Ye("JWS Protected Header incorrect type");if(e.payload===void 0)throw new t.Ye("JWS Payload missing");if(typeof e.signature!="string")throw new t.Ye("JWS Signature missing or incorrect type");if(e.header!==void 0&&!(0,v.A)(e.header))throw new t.Ye("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{let h=(0,g.D4)(e.protected);n=JSON.parse(f.D0.decode(h))}catch{throw new t.Ye("JWS Protected Header is invalid")}if(!(0,j.A)(n,e.header))throw new t.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let b={...n,...e.header},p=(0,d.A)(t.Ye,new Map([["b64",!0]]),u?.crit,n,b),r=!0;if(p.has("b64")&&typeof(r=n.b64)!="boolean")throw new t.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:o}=b;if(typeof o!="string"||!o)throw new t.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let w=u&&((h,y)=>{if(y!==void 0&&(!Array.isArray(y)||y.some(m=>typeof m!="string")))throw TypeError(`"${h}" option must be an array of strings`);if(y)return new Set(y)})("algorithms",u.algorithms);if(w&&!w.has(o))throw new t.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(r){if(typeof e.payload!="string")throw new t.Ye("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new t.Ye("JWS Payload must be a string or an Uint8Array instance");let k=!1;typeof i=="function"?(i=await i(n,e),k=!0,(0,H.I)(o,i,"verify"),(0,l.ll)(i)&&(i=await q(i,o))):(0,H.I)(o,i,"verify");let P=(0,f.xW)(f.Rd.encode(e.protected??""),f.Rd.encode("."),typeof e.payload=="string"?f.Rd.encode(e.payload):e.payload);try{s=(0,g.D4)(e.signature)}catch{throw new t.Ye("Failed to base64url decode the signature")}if(!await W(o,i,s,P))throw new t.h2;if(r)try{c=(0,g.D4)(e.payload)}catch{throw new t.Ye("Failed to base64url decode the payload")}else c=typeof e.payload=="string"?f.Rd.encode(e.payload):e.payload;let S={payload:c};return e.protected!==void 0&&(S.protectedHeader=n),e.header!==void 0&&(S.unprotectedHeader=e.header),k?{...S,key:i}:S}async function F(e,i,u){if(e instanceof Uint8Array&&(e=f.D0.decode(e)),typeof e!="string")throw new t.Ye("Compact JWS must be a string or Uint8Array");let{0:s,1:c,2:n,length:b}=e.split(".");if(b!==3)throw new t.Ye("Invalid Compact JWS");let p=await K({payload:c,protected:s,signature:n},i,u),r={payload:p.payload,protectedHeader:p.protectedHeader};return typeof i=="function"?{...r,key:p.key}:r}var $=a(4239),C=a(3086);let R=e=>e.toLowerCase().replace(/^application\//,"");async function M(e,i,u){let s=await F(e,i,u);if(s.protectedHeader.crit?.includes("b64")&&s.protectedHeader.b64===!1)throw new t.Dp("JWTs MUST NOT use unencoded payload");let c={payload:((n,b,p={})=>{let r,o,w,k;try{r=JSON.parse(f.D0.decode(b))}catch{}if(!(0,v.A)(r))throw new t.Dp("JWT Claims Set must be a top-level JSON object");let{typ:P}=p;if(P&&(typeof n.typ!="string"||R(n.typ)!==R(P)))throw new t.ie('unexpected "typ" JWT header value',r,"typ","check_failed");let{requiredClaims:S=[],issuer:h,subject:y,audience:m,maxTokenAge:A}=p,_=[...S];for(let T of(A!==void 0&&_.push("iat"),m!==void 0&&_.push("aud"),y!==void 0&&_.push("sub"),h!==void 0&&_.push("iss"),new Set(_.reverse())))if(!(T in r))throw new t.ie(`missing required "${T}" claim`,r,T,"missing");if(h&&!(Array.isArray(h)?h:[h]).includes(r.iss))throw new t.ie('unexpected "iss" claim value',r,"iss","check_failed");if(y&&r.sub!==y)throw new t.ie('unexpected "sub" claim value',r,"sub","check_failed");if(m&&(w=r.aud,k=typeof m=="string"?[m]:m,typeof w=="string"?!k.includes(w):!(!!Array.isArray(w)&&k.some(Set.prototype.has.bind(new Set(w))))))throw new t.ie('unexpected "aud" claim value',r,"aud","check_failed");switch(typeof p.clockTolerance){case"string":o=(0,C.A)(p.clockTolerance);break;case"number":o=p.clockTolerance;break;case"undefined":o=0;break;default:throw TypeError("Invalid clockTolerance option type")}let{currentDate:V}=p,D=(0,$.A)(V||new Date);if((r.iat!==void 0||A)&&typeof r.iat!="number")throw new t.ie('"iat" claim must be a number',r,"iat","invalid");if(r.nbf!==void 0){if(typeof r.nbf!="number")throw new t.ie('"nbf" claim must be a number',r,"nbf","invalid");if(r.nbf>D+o)throw new t.ie('"nbf" claim timestamp check failed',r,"nbf","check_failed")}if(r.exp!==void 0){if(typeof r.exp!="number")throw new t.ie('"exp" claim must be a number',r,"exp","invalid");if(r.exp<=D-o)throw new t.n('"exp" claim timestamp check failed',r,"exp","check_failed")}if(A){let T=D-r.iat;if(T-o>(typeof A=="number"?A:(0,C.A)(A)))throw new t.n('"iat" claim timestamp check failed (too far in the past)',r,"iat","check_failed");if(T<0-o)throw new t.ie('"iat" claim timestamp check failed (it should be in the past)',r,"iat","check_failed")}return r})(s.protectedHeader,s.payload,u),protectedHeader:s.protectedHeader};return typeof i=="function"?{...c,key:s.key}:c}},O);export{X as __getNamedExports};
