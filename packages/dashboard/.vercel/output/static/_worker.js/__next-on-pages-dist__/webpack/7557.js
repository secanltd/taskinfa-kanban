var _={},A=(x,S,b)=>(_.__chunk_7557=(m,u,n)=>{"use strict";n.d(u,{XH:()=>y,b9:()=>f});var p=n(7481),d=n(160),r=n(4421);let w=process.env.JWT_SECRET||"dev-secret-change-in-production",k=new TextEncoder().encode(w);async function y(a,e,i,t){let h=(0,r.Lf)(),s=(0,d.Ak)(),l=`tk_${(0,d.Ak)(32)}`,o=new p.P({keyId:s,workspaceId:a}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("365d");t&&(o=o.setExpirationTime(`${t}d`)),await o.sign(k);let T=await c(l),g=t?new Date(Date.now()+24*t*36e5).toISOString():null;return await(0,r.g7)(h,"INSERT INTO api_keys (id, workspace_id, user_id, key_hash, name, expires_at, is_active) VALUES (?, ?, ?, ?, ?, ?, 1)",[s,a,i||null,T,e,g]),{key:l,id:s}}async function E(a){try{let e=(0,r.Lf)(),i=await c(a),t=await(0,r.Zy)(e,"SELECT id, workspace_id, expires_at, is_active FROM api_keys WHERE key_hash = ?",[i]);return!t||!t.is_active||t.expires_at&&new Date(t.expires_at)<new Date?null:(await(0,r.g7)(e,'UPDATE api_keys SET last_used_at = datetime("now") WHERE id = ?',[t.id]),{keyId:t.id,workspaceId:t.workspace_id})}catch(e){return console.error("API key verification failed:",e),null}}async function c(a){let e=new TextEncoder().encode(a);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",e))).map(i=>i.toString(16).padStart(2,"0")).join("")}async function f(a){let e=a.headers.get("authorization");if(!e||!e.startsWith("Bearer "))return null;let i=e.substring(7);return await E(i)}},_);export{A as __getNamedExports};
